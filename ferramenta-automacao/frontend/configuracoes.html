<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações - AutoBiz</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar (mesmo do dashboard.html) -->
    <div class="fixed inset-y-0 left-0 w-64 bg-blue-700 text-white transition-transform duration-300 transform" id="sidebar">
        <div class="flex items-center justify-between h-16 px-4 bg-blue-800">
            <div class="flex items-center">
                <i class="fas fa-store text-2xl mr-2"></i>
                <span class="text-xl font-bold">AutoBiz</span>
            </div>
            <button id="toggleSidebar" class="lg:hidden">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <nav class="mt-5 px-2">
            <a href="dashboard.html" class="group flex items-center px-2 py-2 text-base font-medium rounded-md hover:bg-blue-800">
                <i class="fas fa-chart-line mr-4"></i>
                Dashboard
            </a>
            <a href="estoque.html" class="group flex items-center px-2 py-2 text-base font-medium rounded-md hover:bg-blue-800 mt-1">
                <i class="fas fa-box mr-4"></i>
                Estoque
            </a>
            <a href="notas.html" class="group flex items-center px-2 py-2 text-base font-medium rounded-md hover:bg-blue-800 mt-1">
                <i class="fas fa-file-invoice mr-4"></i>
                Notas Fiscais
            </a>
            <a href="pedidos.html" class="group flex items-center px-2 py-2 text-base font-medium rounded-md hover:bg-blue-800 mt-1">
                <i class="fab fa-whatsapp mr-4"></i>
                Pedidos WhatsApp
            </a>
            <a href="configuracoes.html" class="group flex items-center px-2 py-2 text-base font-medium rounded-md bg-blue-800 mt-1">
                <i class="fas fa-cog mr-4"></i>
                Configurações
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="lg:pl-64">
        <!-- Top bar -->
        <div class="sticky top-0 z-10 flex h-16 bg-white shadow">
            <div class="flex-1 px-4 flex justify-between">
                <div class="flex-1 flex items-center">
                    <h1 class="text-2xl font-semibold text-gray-900">Configurações</h1>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <main class="flex-1">
            <div class="py-6">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
                    <!-- Perfil -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Perfil</h3>
                            <div class="mt-5">
                                <form id="perfilForm" class="space-y-6">
                                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                        <div>
                                            <label for="nome" class="block text-sm font-medium text-gray-700">Nome</label>
                                            <input type="text" name="nome" id="nome" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                            <input type="email" name="email" id="email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" readonly>
                                        </div>
                                    </div>
                                    <div>
                                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            Salvar Alterações
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Alterar Senha -->
                    <div class="mt-6 bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Alterar Senha</h3>
                            <div class="mt-5">
                                <form id="senhaForm" class="space-y-6">
                                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                        <div>
                                            <label for="senhaAtual" class="block text-sm font-medium text-gray-700">Senha Atual</label>
                                            <input type="password" name="senhaAtual" id="senhaAtual" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="novaSenha" class="block text-sm font-medium text-gray-700">Nova Senha</label>
                                            <input type="password" name="novaSenha" id="novaSenha" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        </div>
                                    </div>
                                    <div>
                                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            Alterar Senha
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Plano -->
                    <div class="mt-6 bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Seu Plano</h3>
                            <div class="mt-5">
                                <div class="bg-gray-50 p-4 rounded-md">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-lg font-medium text-gray-900" id="planoAtual">Plano Free</h4>
                                            <p class="mt-1 text-sm text-gray-500" id="planoDescricao">
                                                Até 50 produtos e 30 notas fiscais por mês
                                            </p>
                                        </div>
                                        <button id="upgradePlanBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                            Fazer Upgrade
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notificações -->
                    <div class="mt-6 bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Notificações</h3>
                            <div class="mt-5">
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-900">Alertas de Estoque Baixo</h4>
                                            <p class="mt-1 text-sm text-gray-500">
                                                Receba notificações quando produtos estiverem com estoque baixo
                                            </p>
                                        </div>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notifEstoque" class="form-checkbox h-4 w-4 text-blue-600">
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-900">Novos Pedidos</h4>
                                            <p class="mt-1 text-sm text-gray-500">
                                                Receba notificações quando novos pedidos forem recebidos
                                            </p>
                                        </div>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notifPedidos" class="form-checkbox h-4 w-4 text-blue-600">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Verificar autenticação
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
        }

        // Carregar dados do usuário
        async function carregarPerfil() {
            try {
                const response = await fetch('http://localhost:5000/api/auth/perfil', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar perfil');
                }
                
                const user = await response.json();
                
                // Preencher formulário
                document.getElementById('nome').value = user.nome;
                document.getElementById('email').value = user.email;
                
                // Atualizar informações do plano
                document.getElementById('planoAtual').textContent = 
                    user.plano === 'premium' ? 'Plano Premium' : 'Plano Free';
                document.getElementById('planoDescricao').textContent = 
                    user.plano === 'premium' 
                        ? 'Produtos e notas fiscais ilimitados'
                        : 'Até 50 produtos e 30 notas fiscais por mês';
                
                // Atualizar botão de upgrade
                const upgradeBtn = document.getElementById('upgradePlanBtn');
                if (user.plano === 'premium') {
                    upgradeBtn.textContent = 'Premium Ativo';
                    upgradeBtn.disabled = true;
                    upgradeBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    upgradeBtn.classList.add('bg-gray-400');
                }
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar perfil');
            }
        }

        // Event Listeners
        document.getElementById('perfilForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/perfil', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nome: document.getElementById('nome').value
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao atualizar perfil');
                }
                
                alert('Perfil atualizado com sucesso!');
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao atualizar perfil');
            }
        });

        document.getElementById('senhaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const senhaAtual = document.getElementById('senhaAtual').value;
            const novaSenha = document.getElementById('novaSenha').value;
            
            if (!senhaAtual || !novaSenha) {
                alert('Preencha todos os campos');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/perfil', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        senha: novaSenha
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao alterar senha');
                }
                
                alert('Senha alterada com sucesso!');
                document.getElementById('senhaForm').reset();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao alterar senha');
            }
        });

        document.getElementById('upgradePlanBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://localhost:5000/api/auth/alterar-plano', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        plano: 'premium'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao alterar plano');
                }
                
                alert('Plano alterado para Premium com sucesso!');
                carregarPerfil();
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao alterar plano');
            }
        });

        // Toggle sidebar
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
        });

        // Carregar dados iniciais
        document.addEventListener('DOMContentLoaded', () => {
            carregarPerfil();
        });

        // Salvar preferências de notificação
        ['notifEstoque', 'notifPedidos'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                localStorage.setItem(id, this.checked);
            });
            
            // Carregar preferências salvas
            const saved = localStorage.getItem(id);
            if (saved !== null) {
                document.getElementById(id).checked = saved === 'true';
            }
        });
    </script>
</body>
</html>